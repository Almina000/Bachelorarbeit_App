<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skizze Eingabe</title>
    <link rel="stylesheet" href="static/css/styleAuswahl.css" />
    <script src="../static/js/libraries/p5.min.js"></script>
    <script src="../static/js/libraries/p5.sound.min.js"></script>

    <!-- Pflicht-Skripte (immer geladen) -->
    <script src="../static/js/predictShape.js"></script>
    <!-- <script src="../static/js/data/elbenwald_hashtags_count.js"></script> -->
    <script src="../static/js/surfaceArea.js"></script>
    <script src="../static/js/circle.js"></script>
    <script src="../static/js/calculate_triangles.js"></script>
    <script src="../static/js/calculate_rectangles.js"></script>
    <script src="../static/js/sketch.js"></script>

    <script>
      function loadScript(url, callback) {
          let script = document.createElement("script");
          script.type = "text/javascript";
          script.src = url;

          script.onload = function () {
              console.log(`Script ${url} geladen.`);
              if (callback) callback();
          };

          document.head.appendChild(script);
      }

      // Profilname & Datentyp aus LocalStorage abrufen
      let profile_Name = localStorage.getItem('profileName');
      let data_Name = localStorage.getItem('dataName');

      // Datei dynamisch basierend auf `profileName` und `dataName` laden
      const dataFile = `../static/js/data/${profile_Name}_${data_Name}_count.js`;

      // Prüfen, ob Datei existiert und laden
      fetch(dataFile, { method: 'HEAD' })
          .then(response => {
              if (response.ok) {
                  loadScript(dataFile, function () {
                      console.log("Daten erfolgreich geladen.");
                  });
              } else {
                console.log(`Daten für ${profile_Name}_${data_Name} nicht gefunden.`);
                console.error(`Daten für ${profile_Name}_${data_Name} nicht gefunden.`);
              }
          })
          .catch(error => console.error("Fehler beim Laden der Datei:", error));
    </script>
  </head>
  <body> 
    <div id="startPage">
      <h2>Wählen Sie die Anzahl der Formen</h2>

      <label for="triangles">Dreiecke:</label>
      <input type="range" id="triangles" name="triangles" min="0" max="10" value="5">
      <span id="triangleValue">5</span><br>

      <label for="circles">Kreise:</label>
      <input type="range" id="circles" name="circles" min="0" max="10" value="5">
      <span id="circleValue">5</span><br>

      <label for="rectangles">Rechtecke:</label>
      <input type="range" id="rectangles" name="rectangles" min="0" max="10" value="5">
      <span id="rectangleValue">5</span><br>

      <label for="filterCheckbox">Filter aktivieren:</label>
      <input type="checkbox" id="filterCheckbox"><br>

      <label for="sizeSlider">Größe:</label>
      <input type="range" id="sizeSlider" name="sizeSlider" min="0" max="1" step="0.01" value="0.5">
      <span id="sizeValue">0.5</span><br>

      <p id="warning" style="color: red; display: none;">Die Gesamtanzahl der Formen darf maximal <span id="maxShape"></span> sein.</p>

      <button id="startButton" onclick="startArt()">Weiter</button>
    </div>

    <div id="artwork"></div>

    <script>
      function startArt() {
        const triangles = parseInt(document.getElementById("triangles").value);
        const circles = parseInt(document.getElementById("circles").value);
        const rectangles = parseInt(document.getElementById("rectangles").value);
        
        const total = triangles + circles + rectangles;
        
        const filter = document.getElementById("filterCheckbox").checked;
        localStorage.setItem("filter", filter);
        
        const size = parseFloat(document.getElementById("sizeSlider").value);
        localStorage.setItem("size", size);

        // Daten abrufen & Maximale Anzahl berechnen
        const profileName = localStorage.getItem("profileName");
        const dataName = localStorage.getItem("dataName");

        const dataPath = window[`${profileName}_${dataName}`] || []; 
        if (dataPath) {
            localStorage.setItem("dataPath", JSON.stringify(dataPath));
            console.log("Gespeichert in localStorage:", dataPath);
        } else {
            console.error("Daten nicht gefunden:", `${profileName}_${dataName}`);
        }

        const maxShape = dataPath.length || 0;
        console.log('Größe 1:', maxShape);
        
        // Prüfen, ob die Gesamtzahl der Formen gültig ist
        if (total <= maxShape) {
            // Speichert die gewählte Form-Anzahl in `localStorage`
            localStorage.setItem("shapeCounts", JSON.stringify({ triangles, circles, rectangles }));

            // Weiter zur nächsten Seite (ohne Flask)
            window.location.href = "artwork.html"; 
        } else {
            // Warnung anzeigen, wenn zu viele Formen gewählt wurden
            document.getElementById("warning").style.display = "block";
        }
      }

      function checkTotal() {
        const triangles = parseInt(document.getElementById("triangles").value);
        const circles = parseInt(document.getElementById("circles").value);
        const rectangles = parseInt(document.getElementById("rectangles").value);
        const total = triangles + circles + rectangles;


        let maxShape = window[`${profileName}_${dataName}`]?.length || 0;
        console.log('maxShape:', maxShape);

        document.getElementById("maxShape").textContent = maxShape;
        document.getElementById("warning").style.display = total > maxShape ? "block" : "none";
      }

      document.getElementById("sizeSlider").oninput = function () {
        document.getElementById("sizeValue").textContent = this.value;
      };
      document.getElementById("triangles").oninput = function () {
        document.getElementById("triangleValue").textContent = this.value;
        checkTotal();
      };
      document.getElementById("circles").oninput = function () {
        document.getElementById("circleValue").textContent = this.value;
        checkTotal();
      };
      document.getElementById("rectangles").oninput = function () {
        document.getElementById("rectangleValue").textContent = this.value;
        checkTotal();
      };
    </script>
  </body>
</html>
